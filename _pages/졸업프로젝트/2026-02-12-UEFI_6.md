---
title: "UEFI DXE ë°”ì´ë„ˆë¦¬ ì·¨ì•½ì  ë¶„ì„ê¸° í”„ë¡œì íŠ¸_6"
tags: [UEFI, Ghidra]
toc: true
math: true
date: 2026-02-12 11:00 +0800
thumbnail: "/image/javaGhidra.png"
---
## í”„ë¡œì íŠ¸ ìµœì¢… ë¶„ë°°
&nbsp;í”„ë¡œì íŠ¸ ìµœì¢… ì¸ì› ë¶„ë°°ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ê²°ì •í–ˆë‹¤.
1. Ring -2 ì·¨ì•½ì  ë¶„ì„ ë° ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±, ìµœì¢… ë¬¸ì„œí™”
2. DXE Dispatcher ì·¨ì•½ì  ë¶„ì„ ë° ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
3. Ring 0 ì·¨ì•½ì  ë¶„ì„ ë° ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
4. ì·¨ì•½ì  ì½”ë“œ ìƒì„± ë° í…ŒìŠ¤íŠ¸
5. ìŠ¤í¬ë¦½íŠ¸ ìë™í™” ë° ìµœì¢… ë¬¸ì„œí™”
 
ì´ë ‡ê²Œ ë‚˜ëˆ´ê³  ë‚œ 1ë²ˆ ì—­í• ì„ ë‹´ë‹¹í•˜ê¸°ë¡œ í•˜ì˜€ë‹¤.

## Intellij Ghidra ì„¤ì • ë°©ë²•
&nbsp;ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë‹´ë‹¹í•  ì¡°ì›ë“¤ë¼ë¦¬ëŠ” Ghidraê°€ Javaë¡œ ì“°ì¸ ë§Œí¼ Javaë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ê¸°ë¡œ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ´ë‹¤. ì‚¬ì‹¤ Jythonìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§œë‹¤ê°€ Javaë¡œ ë„˜ì–´ê°€ëŠ” ë°”ëŒì— ì„¤ì •ì—ì„œ ì‚½ì§ˆì„ ì¡°ê¸ˆ í–ˆë‹¤...
ì„¤ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
1. Intellij ì„¤ì¹˜ ë° í”„ë¡œì íŠ¸ ìƒì„±
2. íŒŒì¼ -> í”„ë¡œì íŠ¸ êµ¬ì¡° -> ëª¨ë“ˆ
3. \+ í´ë¦­ -> JAR ë˜ëŠ” ë””ë ‰í† ë¦¬
4. ì•„ë˜ ë””ë ‰í† ë¦¬ ë‚´ë¶€ JAR íŒŒì¼ë“¤ì„ ì „ë¶€ ì„í¬íŠ¸í•˜ê¸°
(Mac Homebrew ì„¤ì¹˜ ê¸°ì¤€(opt/homebrew/Cellar/Ghidra/12.02/libexec/Ghidra)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.)
(ì•„ë§ˆ ìœˆë„ìš° ì—­ì‹œ ë¹„ìŠ·í•œ ê²½ë¡œì— ìˆì„ ê²ƒìœ¼ë¡œ ìƒê°ëœë‹¤...)
(ë³¸ì¸ì´ ì¼ë‹¨ ë‹¤ ë°›ê³  ë³¸ ë¶€ë¶„ë„ ì—†ì§€ ì•Šì•„ ìˆì–´ ì–´ë–¤ê±´ í•„ìš”í•˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆê³ , ë” í•„ìš”í•œê²Œ ìˆì„ ìˆ˜ë„ ìˆë‹¤.)
    1. Features/Base/lib
    2. Framework/SoftwareModeling/lib
    3. Framework/Generic/lib
    4. Framework/Docking/lib
    5. Framework/Project/lib
    6. Features/Decompiler/lib
    7. Framework/Utility/lib

ìœ„ì™€ ê°™ì´ ì˜ ì§„í–‰í–ˆë‹¤ë©´
![ì œëª©](/image/javaGhidra.png)
ìœ„ ì´ë¯¸ì§€ì™€ ê°™ì´ Ghidra ë¬¸ë²•ì— ìë™ì™„ì„±ì´ ì˜ ì¡íŒë‹¤!

## ê°„ë‹¨í•œ íƒì§€ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
```java
    @Override
    public void run() throws Exception {
        println("=== SMM Indirect Call ê²€ì¦ê¸° (Safety Check íƒì§€) ì‹œì‘ ===");

        InstructionIterator instructions = currentProgram.getListing().getInstructions(true);
        int suspiciousCount = 0;
        int highRiskCount = 0;

        while (instructions.hasNext()) {
            if (monitor.isCancelled()) break;
            Instruction instr = instructions.next();

            // 1. CALL ëª…ë ¹ì–´ ì°¾ê¸°
            if (!instr.getMnemonicString().equalsIgnoreCase("CALL")) continue;

            // 2. ì˜¤í¼ëœë“œ ë¶„ì„ (RAX, RBX ë“± ë ˆì§€ìŠ¤í„° í˜¸ì¶œì¸ì§€?)
            String opString = instr.getDefaultOperandRepresentation(0);

            // "0x..." ê³ ì • ì£¼ì†Œ í˜¸ì¶œì´ë‚˜ "[...]" ë©”ëª¨ë¦¬ ì°¸ì¡°ëŠ” ì¼ë‹¨ íŒ¨ìŠ¤ (ë³µì¡í•˜ë‹ˆê¹Œ)
            // ì˜¤ì§ "CALL RAX", "CALL R12" ê°™ì€ ìˆœìˆ˜ ë ˆì§€ìŠ¤í„° í˜¸ì¶œë§Œ ì§‘ì¤‘ íƒ€ê²©!
            boolean isRegisterCall = !opString.contains("[") && !opString.startsWith("0x");

            if (isRegisterCall) {
                // í˜¸ì¶œì— ì‚¬ìš©ëœ ë ˆì§€ìŠ¤í„° ê°€ì ¸ì˜¤ê¸° (ì˜ˆ: RAX)
                Register callReg = instr.getRegister(0);

                if (callReg != null) {
                    //í•µì‹¬: ë’¤ë¡œ 15ì¤„ ê²€ìƒ‰í•´ì„œ CMPë‚˜ TESTê°€ ìˆëŠ”ì§€ í™•ì¸!
                    boolean isChecked = hasSafetyCheck(instr, callReg, 15);

                    if (!isChecked) {
                        println(String.format("ğŸš¨ [ì´ˆìœ„í—˜/No-Check] ì£¼ì†Œ: %s | ì½”ë“œ: %s | (ê²€ì¦ ë¡œì§ ë°œê²¬ ëª»í•¨)",
                                instr.getAddress(), instr.toString()));
                        highRiskCount++;
                    } else {
                        println(String.format("âœ… [ì•ˆì „ ì¶”ì •] ì£¼ì†Œ: %s | ì½”ë“œ: %s | (ê²€ì¦ ë¡œì§ ìˆìŒ)",
                                instr.getAddress(), instr.toString()));
                    }
                    suspiciousCount++;
                }
            }
        }

        println("==========================================");
        println("ë¶„ì„ ì™„ë£Œ: ì´ " + suspiciousCount + "ê°œ ì¤‘ " + highRiskCount + "ê°œê°€ 'ê²€ì¦ ì—†ëŠ” ìœ„í—˜ í˜¸ì¶œ'ë¡œ ë³´ì…ë‹ˆë‹¤.");
    }

    // ë’¤ë¡œ ê±¸ì–´ê°€ë©´ì„œ ê²€ì‚¬ ë¡œì§(CMP, TEST) ì°¾ëŠ” í•¨ìˆ˜
    private boolean hasSafetyCheck(Instruction startInstr, Register targetReg, int maxSteps) {
        Instruction current = startInstr.getPrevious(); // ë°”ë¡œ ìœ—ì¤„ë¶€í„° ì‹œì‘
        int steps = 0;

        while (current != null && steps < maxSteps) {
            String mnemonic = current.getMnemonicString();

            // 1. ë¹„êµ(CMP)ë‚˜ í…ŒìŠ¤íŠ¸(TEST) ëª…ë ¹ì–´ë¥¼ ì°¾ìŒ
            if (mnemonic.equalsIgnoreCase("CMP") || mnemonic.equalsIgnoreCase("TEST")) {
                // 2. ê·¸ ëª…ë ¹ì–´ê°€ ìš°ë¦¬ê°€ ì˜ì‹¬í•˜ëŠ” ë ˆì§€ìŠ¤í„°(targetReg)ë¥¼ ì“°ëŠ”ì§€ í™•ì¸
                // ì˜ˆ: CALL RAXì¸ë°, ìœ„ì—ì„œ CMP RAX, 0x100 ì„ í–ˆë‹¤ë©´? -> ë¹™ê³ !
                Object[] opObjects = current.getOpObjects(0); // ì²« ë²ˆì§¸ ì˜¤í¼ëœë“œ
                for (Object op : opObjects) {
                    if (op instanceof Register && ((Register) op).equals(targetReg)) {
                        return true; // ì•ˆì „ì¥ì¹˜ ë°œê²¬!
                    }
                }
            }

            // ë§Œì•½ ë ˆì§€ìŠ¤í„° ê°’ì´ ì—¬ê¸°ì„œ ë®ì–´ì”Œì›Œì¡Œë‹¤ë©´(MOV RAX, ...), ê·¸ ìœ„ëŠ” ë³¼ í•„ìš” ì—†ìŒ (ì¶”ì  ëŠê¹€)
            if (mnemonic.equalsIgnoreCase("MOV") || mnemonic.equalsIgnoreCase("LEA")) {
                Object[] resultObjects = current.getResultObjects();
                for (Object res : resultObjects) {
                    if (res instanceof Register && ((Register) res).equals(targetReg)) {
                        return false; // ê°’ì„ ë§‰ ëŒ€ì…í•˜ê³  ë°”ë¡œ í˜¸ì¶œí•¨ -> ìœ„í—˜!
                    }
                }
            }

            current = current.getPrevious(); // í•œ ì¤„ ë” ìœ„ë¡œ
            steps++;
        }
        return false; // ëê¹Œì§€ ê²€ì‚¬ ë¡œì§ ëª» ì°¾ìŒ
    }
```
ì¼ë‹¨ ê°ì´ë¼ë„ ì¢€ ì¡ì•„ë³´ê¸° ìœ„í•´ ì œë¯¸ë‚˜ì´ì™€ í•¨ê»˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í•˜ë‚˜ ì§œë´¤ë‹¤. ì½”ë“œ ì•„ì´ë””ì–´ëŠ” ë§¤ìš° ë‹¨ìˆœí•œ í˜•íƒœë¡œ, instruction ì¤‘ CALLì„, ê·¸ ì¤‘ì—ì„œë„ ë ˆì§€ìŠ¤í„°ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì„ ë°œê²¬í•œë‹¤ë©´ í•´ë‹¹ instruction ìœ„ë¡œ 15ê°œ instructionì„ í™•ì¸í•´ì„œ, ê·¸ ì¤‘ TESTë‚˜ CMPê°€ ìˆëŠ”ì§€ í™•ì¸ì„ í•˜ê³ , ë˜ëŠ” ê·¸ ì‚¬ì´ì— í•´ë‹¹ ë ˆì§€ìŠ¤í„° ê°’ì´ ë®ì–´ì”Œì›Œì§€ëŠ”ì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ë“±ì˜ ë¡œì§ì„ í™•ì¸í•œë‹¤. 
